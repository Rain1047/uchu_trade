# UTC-4时区K线数据获取机制

## 概述

系统现在支持UTC-4时区（美国东部夏令时EDT）作为日线边界，这对于分析美国市场时间具有重要意义。

## UTC-4时区特点

### 时间边界定义
- **日线数据（1d）**：每条记录代表从前一日美国东部时间00:00到当日美国东部时间00:00的24小时数据
- **边界时间**：美国东部时间午夜（00:00）
- **时区偏移**：UTC-4（夏令时）或UTC-5（标准时间）

### 与其他时区对比

| 时区模式 | 边界时间 | 示例日期显示 | 实际时间范围 |
|---------|---------|-------------|-------------|
| UTC-4 | 00:00 EDT | 2025-05-31 00:00:00-04:00 | 5月30日00:00 ~ 5月31日00:00 |
| UTC+8 | 08:00 CST | 2025-05-31 08:00:00+08:00 | 5月30日08:00 ~ 5月31日08:00 |
| UTC | 00:00 UTC | 2025-05-31 00:00:00+00:00 | 5月30日00:00 ~ 5月31日00:00 |

### 时差关系
- **UTC-4 vs UTC+8**: 相差12小时
- **美国东部时间早于中国时间12小时**
- 例如：美国5月31日00:00 = 中国5月31日12:00

## 使用方法

### 1. 直接使用OKX获取器（UTC-4）
```python
from backend.data_center.kline_data.okx_kline_fetcher import OkxKlineFetcher

# 使用UTC-4时区
fetcher = OkxKlineFetcher("/path/to/data", timezone_mode="UTC-4")

# 获取日线数据（美国东部时间边界）
df = fetcher.get_historical_data("BTC", "1d", 
                                start_date="2025-05-30", 
                                end_date="2025-05-31")

print("数据时间戳将显示为: 2025-05-30 00:00:00-04:00")
```

### 2. 通过数据管理器使用
```python
from backend.data_center.kline_data.enhanced_kline_manager import EnhancedKlineManager

# 指定UTC-4时区
manager = EnhancedKlineManager(timezone_mode="UTC-4")

df = manager.load_raw_data("BTC", "1d", 
                          start_date="2025-05-30", 
                          end_date="2025-05-31")
```

### 3. 在回测中使用
```python
from backend.backtest_center.universal_backtest_engine import UniversalBacktestEngine

# 创建使用UTC-4时区的回测引擎
engine = UniversalBacktestEngine(timezone_mode="UTC-4")

# 运行回测
config = BacktestConfig(
    symbols=['BTC'],
    timeframe='1d',
    backtest_period='3m'
)

result = engine.run_backtest(config)
```

## 时区选择建议

### 使用UTC-4的场景
1. **美国市场分析**：分析美国股市、期货等金融产品
2. **与美国时间同步**：需要与美国交易时间保持一致
3. **纽约时间为基准**：以纽约金融市场时间为参考
4. **全球金融中心**：纽约是重要的全球金融中心

### 使用UTC+8的场景
1. **亚洲市场分析**：分析中国、日本、新加坡等亚洲市场
2. **中国投资者**：符合中国投资者的时间习惯
3. **亚洲交易时间**：与亚洲主要交易时间一致

### 使用UTC的场景
1. **全球标准**：需要统一的全球时间标准
2. **系统间同步**：多个系统需要统一时间基准
3. **技术分析**：纯技术分析，不依赖特定时区

## 数据格式示例

### UTC-4时区数据
```csv
,open,high,low,close,volume,symbol
2025-05-30 00:00:00-04:00,107034.0,107180.0,104595.4,105538.8,8608.79,Binance:BTCUSDT
2025-05-31 00:00:00-04:00,105538.8,105565.4,103078.7,104554.2,5156.21,Binance:BTCUSDT
```

### 数据解读
- **时间戳**：显示美国东部时间，带有-04:00时区标识
- **5月31日数据**：代表5月30日00:00到5月31日00:00（美国东部时间）的交易数据
- **价格连续性**：每日收盘价等于次日开盘价，确保数据连续性

## 注意事项

### 1. 夏令时处理
- **UTC-4**：美国东部夏令时（3月-11月）
- **UTC-5**：美国东部标准时（11月-3月）
- 系统自动处理夏令时转换

### 2. 仅影响日线数据
- **1d（日线）**：应用UTC-4边界
- **1h, 4h, 12h等**：使用标准UTC时间

### 3. 数据一致性
- 同一交易日数据始终对应相同的24小时窗口
- 避免跨时区数据混淆
- 时间戳包含完整时区信息

### 4. 系统兼容性
- 向后兼容，现有代码无需修改
- 可以同时使用多种时区模式
- 数据缓存按时区分别管理

## 验证方法

```python
# 测试UTC-4时区
python backend/data_center/kline_data/okx_kline_fetcher.py

# 检查输出日志
# 应该看到类似：
# 时间范围调整(UTC-4):
#   输入: 2025-05-30 ~ 2025-05-31
#   美国东部时间: 2025-05-30 00:00:00-04:00 ~ 2025-05-31 00:00:00-04:00
#   UTC时间: 2025-05-30 04:00:00+00:00 ~ 2025-05-31 04:00:00+00:00
```

这确保了数据的时区处理正确性和一致性。 